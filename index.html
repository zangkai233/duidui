<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å‘åœˆå¯¹å¯¹ç¢°Â·å®Œæ•´ç‰ˆï¼ˆåŠ¨æ€æ™ºèƒ½å°è£…ï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:#f0f2f5;margin:0}
    .container{max-width:960px;margin:auto;padding:20px}
    .view{display:none}
    .auth-container{max-width:420px;margin:80px auto;background:#fff;padding:24px;
      border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
    .auth-container h2{text-align:center;margin-bottom:20px}
    .auth-container input,.auth-container button{width:100%;padding:10px;margin:8px 0;
      box-sizing:border-box}
    .auth-container a{color:#1677ff;cursor:pointer}
    .topbar{display:flex;justify-content:space-between;align-items:center;
      background:#fff;padding:12px 20px;box-shadow:0 2px 4px rgba(0,0,0,.08);
      position:relative}
    #accountPanel{position:absolute;top:52px;right:20px;width:260px;background:#fff;
      border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);overflow:hidden;
      height:0;transition:.3s;padding:0}
    #accountPanel.open{height:220px;padding:12px}
    .main{display:flex;margin-top:20px}
    .sidebar{width:260px;background:#fff;padding:20px;border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .sidebar input,.sidebar button,.sidebar select{width:100%;padding:8px;
      margin:8px 0;box-sizing:border-box}
    .content{flex:1;padding:0 24px}
    #gameArea{display:grid;grid-template-columns:repeat(3,80px);
      grid-gap:12px;margin-top:20px;min-height:264px}
    .cell{width:80px;height:80px;border-radius:50%;display:flex;
      justify-content:center;align-items:center;font-weight:bold;
      font-size:14px;opacity:0;transform:scale(.3);transition:.3s}
    .cell.show{opacity:1;transform:scale(1)}
    #scoreBoard{margin-top:12px;font-size:16px}
    #priceList{margin-top:16px;background:#fff;padding:12px;border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,.08)}
    #priceList ul{list-style:none;padding-left:0;margin:0}
    #priceList li{margin:4px 0}
    #logArea{height:160px;background:#fff;border-radius:6px;
      box-shadow:0 1px 3px rgba(0,0,0,.08);margin-top:20px;padding:10px;
      overflow:auto;font-size:13px;line-height:1.45}
  </style>
</head>
<body>
<div class="container">

  <!-- ç™»å½• -->
  <div id="loginView" class="view auth-container">
    <h2>ç™»å½•</h2>
    <input id="loginPhone" placeholder="æ‰‹æœºå· / admin">
    <input id="loginPass" type="password" placeholder="å¯†ç ">
    <button id="loginBtn">ç™»å½•</button>
    <p>æ²¡æœ‰è´¦å·ï¼Ÿ<a id="toRegister">æ³¨å†Œ</a></p>
  </div>

  <!-- æ³¨å†Œ -->
  <div id="registerView" class="view auth-container">
    <h2>æ³¨å†Œ</h2>
    <input id="regPhone" placeholder="æ‰‹æœºå·">
    <input id="regPass" type="password" placeholder="å¯†ç (â‰¥6ä½)">
    <button id="registerBtn">æ³¨å†Œ</button>
    <p>å·²æœ‰è´¦å·ï¼Ÿ<a id="toLogin">ç™»å½•</a></p>
  </div>

  <!-- ç®¡ç†å‘˜ -->
  <div id="adminView" class="view">
    <div class="topbar">
      <div>ç®¡ç†å‘˜å®¡æ ¸</div>
      <button id="logoutAdmin">é€€å‡ºç™»å½•</button>
    </div>
    <div class="content">
      <h3>å¾…å®¡è®¢å•</h3>
      <ul id="orderList"></ul>
    </div>
  </div>

  <!-- æ¸¸æˆç•Œé¢ -->
  <div id="gameView" class="view">
    <div class="topbar">
      <div>å‘åœˆå¯¹å¯¹ç¢°</div>
      <div id="accountToggle" style="cursor:pointer">æˆ‘çš„è´¦æˆ·</div>
      <div id="accountPanel">
        <div>æ‰‹æœºå·: <span id="accountPhone"></span></div>
        <div>ä½™é¢:  <span id="accountBalance"></span> å…ƒ</div>
        <div>ç¤¼åŒ…:  <span id="accountBags"></span> åŒ…</div>
        <div>æ€»ç§¯åˆ†: <span id="accountTotal"></span></div>
        <div>ç§¯åˆ†å…‘æ¢:
          <input id="redeemPoints" type="number" min="1" placeholder="è¦å…‘æ¢çš„ç§¯åˆ†" style="width:60px;">
          <button id="redeemBtn" style="padding:2px 6px;">å…‘æ¢</button>
        </div>
        <button id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>
    <div class="main">
      <div class="sidebar">
        <h3>å……å€¼</h3>
        <input id="rechargeAmount" type="number" min="1" placeholder="å……å€¼é‡‘é¢">
        <button id="rechargeBtn">æäº¤å……å€¼</button>
        <p id="rechargeStatus" style="color:#f60"></p>
        <button id="refreshBalance">åˆ·æ–°èµ„äº§</button>
        <hr>
        <h3>è´­ä¹°ç¤¼åŒ…</h3>
        <select id="packPrice">
          <option value="29.9">Â¥29.9 â†’ 2åŒ…</option>
          <option value="49.9">Â¥49.9 â†’ 3åŒ…</option>
          <option value="79.9">Â¥79.9 â†’ 5åŒ…</option>
          <option value="169.9">Â¥169.9 â†’ 10åŒ…</option>
          <option value="299.9">Â¥299.9 â†’ 20åŒ…</option>
        </select>
        <button id="buyPackBtn">è´­ä¹°ç¤¼åŒ…</button>
        <hr>
        <h3>æœ¬å±€å¼€åŒ…æ•°</h3>
        <select id="openCount"></select>
        <hr>
        <h3>è®¸æ„¿è‰²</h3>
        <select id="wishColorSelect"></select>
      </div>
      <div class="content">
        <button id="startGameBtn">å¼€å§‹æ¸¸æˆ</button>
        <button id="manualClearBtn">æ‰‹åŠ¨æ¸…å°</button>
        <div id="gameArea"></div>
        <div id="scoreBoard">
          å‰©ä½™åŒ…æ•°: <span id="pkgLeft">0</span> |
          å·²å¼€åœˆæ•°: <span id="score">0</span>
        </div>
        <div id="priceList">
          <h3>ä»·æ ¼-åŒ…æ•°å¯¹ç…§</h3>
          <ul>
            <li>Â¥29.9 â†’ 2 åŒ…</li>
            <li>Â¥49.9 â†’ 3 åŒ…</li>
            <li>Â¥79.9 â†’ 5 åŒ…</li>
            <li>Â¥169.9 â†’ 10 åŒ…</li>
            <li>Â¥299.9 â†’ 20 åŒ…</li>
          </ul>
        </div>
        <div id="logArea"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const apiBase = "https://api.duidui.uk";
  const COLORS = ["çº¢","æ©™","é»„","ç»¿","è“","ç´«","ç²‰","é»‘","ç™½","ç°"];
  const COLOR_HEX = {çº¢:"#ff4d4f",æ©™:"#ffa940",é»„:"#ffec3d",ç»¿:"#73d13d",è“:"#40a9ff",ç´«:"#9254de",ç²‰:"#ff85c0",é»‘:"#595959",ç™½:"#ffffff",ç°:"#8c8c8c"};
  const BRIGHT = new Set(["é»„","ç™½"]);
  const REWARD_VALUES = {wish:1, pair:1, triple:3, fullhouse:5};
  const tableMin = {2:2,3:4,5:7,10:15,20:28};
  const tableMax = {2:3,3:5,5:8,10:17,20:32};
  const $ = id => document.getElementById(id);

  // æ ¹æ®åˆå§‹åŒ…æ•°è¿”å›ç›®æ ‡åŒºé—´
  function getTargetRange(n) {
    if (tableMin[n]!==undefined) return {min:tableMin[n], max:tableMax[n]};
    if (n > 20) return {min:Math.floor(n*1.4), max:Math.ceil(n*1.6)};
    if (n > 10) return {min:Math.floor(n*1.35), max:Math.ceil(n*1.5)};
    return {min:tableMin[5], max:tableMax[5]};
  }

  function show(view){
    ["loginView","registerView","gameView","adminView"]
      .forEach(v=>$(v).style.display=v===view?"block":"none");
  }
  function log(msg){
    const d=document.createElement("div");
    d.textContent=msg;
    $("logArea").appendChild(d);
    $("logArea").scrollTop = $("logArea").scrollHeight;
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function setUser(u){ sessionStorage.setItem("u",JSON.stringify(u)); }
  function getUser(){ return JSON.parse(sessionStorage.getItem("u")||"null"); }
  function clearUser(){ sessionStorage.removeItem("u"); }

  async function fetchProfile(){
    const u=getUser(); if(!u) return;
    const res = await fetch(`${apiBase}/profile?phone=${u.phone}`);
    const d = await res.json();
    if(d.status==="success"){
      $("accountBalance").textContent = d.balance.toFixed(2);
      $("accountBags").textContent = d.bags;
      $("accountTotal").textContent = d.total_score;
    }
  }

  window.onload = ()=>{
    for(let i=2;i<=60;i++){
      const o=document.createElement("option");
      o.value=i; o.textContent=`${i} åŒ…`;
      $("openCount").appendChild(o);
    }
    COLORS.forEach(c=>{
      const o=document.createElement("option");
      o.value=c; o.textContent=c;
      $("wishColorSelect").appendChild(o);
    });
    const u=getUser();
    if(!u) return show("loginView");
    if(u.role==="admin"){ loadOrders(); show("adminView"); }
    else{ show("gameView"); fetchProfile(); }
  };

  // æ³¨å†Œ / ç™»å½• / ç™»å‡º
  $("toRegister").onclick = ()=> show("registerView");
  $("toLogin").onclick    = ()=> show("loginView");
  $("registerBtn").onclick = async ()=>{
    const p=$("regPhone").value.trim(), pwd=$("regPass").value;
    if(!p||!pwd) return alert("è¯·å¡«å†™å®Œæ•´");
    const r=await fetch(apiBase+"/register", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({phone:p,password:pwd})
    });
    const d=await r.json();
    if(d.status==="success"){ alert("æ³¨å†ŒæˆåŠŸ"); show("loginView"); }
    else alert(d.message);
  };
  $("loginBtn").onclick = async ()=>{
    const p=$("loginPhone").value.trim(), pwd=$("loginPass").value;
    if(!p||!pwd) return alert("è¯·å¡«å†™å®Œæ•´");
    const r=await fetch(apiBase+"/login", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({phone:p,password:pwd})
    });
    const d=await r.json();
    if(d.status!=="success") return alert(d.message);
    setUser({role:d.role,phone:p});
    if(d.role==="admin"){ loadOrders(); show("adminView"); }
    else{ show("gameView"); fetchProfile(); }
  };
  $("logoutBtn").onclick = $("logoutAdmin").onclick = ()=>{
    clearUser(); show("loginView");
  };
  $("accountToggle").onclick = ()=> $("accountPanel").classList.toggle("open");

  // å……å€¼ & è´­ä¹°
  $("refreshBalance").onclick = fetchProfile;
  $("rechargeBtn").onclick = async ()=>{
    const a=parseFloat($("rechargeAmount").value);
    if(isNaN(a)||a<=0) return alert("é‡‘é¢æ— æ•ˆ");
    $("rechargeStatus").textContent="å®¢æœå®¡æ ¸ä¸­";
    const u=getUser();
    await fetch(apiBase+"/order", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({phone:u.phone,amount:a})
    });
  };
  $("buyPackBtn").onclick = async ()=>{
    const pr=parseFloat($("packPrice").value), u=getUser();
    const r=await fetch(apiBase+"/buy_pack", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({phone:u.phone,price:pr})
    });
    const d=await r.json();
    if(d.status!=="success") return alert(d.message);
    $("accountBalance").textContent = d.balance.toFixed(2);
    $("accountBags").textContent    = d.bags;
    alert("è´­ä¹°æˆåŠŸ");
  };

  // ç®¡ç†å‘˜å®¡æ ¸
  async function loadOrders(){
    const r=await fetch(apiBase+"/orders"), d=await r.json();
    if(d.status!=="success") return;
    $("orderList").innerHTML="";
    d.orders.forEach(o=>{
      const li=document.createElement("li");
      li.textContent=`æ‰‹æœºå·:${o.phone} é‡‘é¢:${o.amount}`;
      const btn=document.createElement("button");
      btn.textContent="æ‰¹å‡†";
      btn.onclick=async ()=>{
        const rr=await fetch(apiBase+"/order/approve", {
          method:"POST", headers:{"Content-Type":"application/json"},
          body:JSON.stringify({orderId:o.id})
        });
        const dd=await rr.json();
        if(dd.status==="success") loadOrders();
        else alert(dd.message);
      };
      li.appendChild(btn);
      $("orderList").appendChild(li);
    });
  }

  // æ¸¸æˆçŠ¶æ€
  let board=[], pkgLeft=0, score=0, wishColor="";
  let rewardUsed={}, opensDone=0, desiredCount=0, colorCounts={};

  // å¼€å§‹æ¸¸æˆ
  $("startGameBtn").onclick = async ()=>{
    desiredCount = parseInt($("openCount").value,10);
    wishColor = $("wishColorSelect").value;
    opensDone = 0; score = 0; colorCounts = {};
    rewardUsed = {wish:false,pair:false,triple:false,fullhouse:false};

    const u=getUser();
    const r=await fetch(apiBase+"/start_game", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({phone:u.phone,count:desiredCount})
    });
    const d=await r.json();
    if(d.status!=="success") return alert(d.message);
    pkgLeft = d.initial;

    board = Array(9).fill(null);
    $("pkgLeft").textContent = pkgLeft;
    $("score").textContent  = score;
    $("accountBags").textContent = d.bags_left;
    $("gameArea").innerHTML = "";
    for(let i=0;i<9;i++){
      const c=document.createElement("div"); c.className="cell";
      $("gameArea").appendChild(c);
    }
    $("logArea").innerHTML="";
    log(`ğŸ® æ¸¸æˆå¼€å§‹ï¼š${desiredCount}åŒ…ï¼Œè®¸æ„¿è‰²ã€Œ${wishColor}ã€`);

    while(pkgLeft>0){
      await openOnePackage();
      await sleep(700);
    }
    log("ğŸ‰ æœ¬å±€ç»“æŸï¼Œæœ¬è‰²ç»Ÿè®¡ï¼š");
    COLORS.forEach(c=>{ if(colorCounts[c]) log(`  ${c}: ${colorCounts[c]}`); });
    await fetch(apiBase+"/submit_score", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({phone:getUser().phone,score})
    });
  };

  // æ™ºèƒ½åŠ¨æ€å¼€åŒ…
  async function openOnePackage(){
    const idx = board.indexOf(null);
    if(idx===-1){
      rewardUsed={wish:false,pair:false,triple:false,fullhouse:false};
      removeAll(); log("âš ï¸ å°é¢æ»¡ï¼Œè‡ªåŠ¨æ¸…å°"); return;
    }

    // è®¡ç®—é¢å¤–å·²å¾—
    const extraSoFar = opensDone - desiredCount;
    // ç›®æ ‡åŒºé—´
    const {min: tgMin, max: tgMax} = getTargetRange(desiredCount);
    const needMin = tgMin - desiredCount;
    const needMax = tgMax - desiredCount;
    // å‰©ä½™å¯è§¦å‘å¥–åŠ±å€¼
    let remMax=0;
    for(const k in REWARD_VALUES) if(!rewardUsed[k]) remMax += REWARD_VALUES[k];

    let color;

    // 1. è‹¥å†ä¸è§¦å‘ï¼Œæ½œåŠ›ä¸è¶³ â†’ å¼ºåˆ¶è§¦å‘
    if(extraSoFar + remMax < needMin){
      if(!rewardUsed.fullhouse && canFullhouse()){
        color = pickMissingForFullhouse();
      } else {
        const tri = canTrigger("triple");
        if(!rewardUsed.triple && tri) color = tri;
        else {
          const pr = canTrigger("pair");
          if(!rewardUsed.pair && pr) color = pr;
          else if(!rewardUsed.wish) color = wishColor;
        }
      }
    }
    // 2. è‹¥å¯èƒ½è¶…ä¸Šé™ â†’ é€‰å®‰å…¨è‰²
    if(color===undefined && extraSoFar > needMax){
      color = pickSafeColor();
    }
    // 3. ä¸´è¿‘ç»“æŸï¼Œè‹¥å…¨å®¶ç¦å°šæœªè§¦å‘ä¸”èƒ½åŠ©åŠ›åˆ°è¾¾ä¸‹é™ â†’ å¼ºåˆ¶å…¨å®¶ç¦
    if(color===undefined && pkgLeft <= 5 && !rewardUsed.fullhouse 
       && extraSoFar + REWARD_VALUES.fullhouse <= needMax){
      color = pickMissingForFullhouse();
    }
    // 4. å¦åˆ™éšæœº
    if(color===undefined){
      color = COLORS[Math.floor(Math.random()*COLORS.length)];
    }

    // æ”¾ç½®
    opensDone++; pkgLeft--; $("pkgLeft").textContent = pkgLeft;
    board[idx] = color; drawCell(idx,color,true);
    log(`ğŸ“¦ å¼€åŒ…${opensDone}: æŠ½åˆ°ã€Œ${color}ã€`);
    score++; colorCounts[color] = (colorCounts[color]||0) + 1;
    $("score").textContent = score;

    // å¥–åŠ±åˆ¤å®š
    if(color===wishColor && !rewardUsed.wish){
      rewardUsed.wish = true; pkgLeft++; log("ğŸ¯ è®¸æ„¿ +1åŒ…");
    }
    let loop=true;
    while(loop){
      loop=false;
      const t = findTriples();
      if(t.length && !rewardUsed.triple){
        rewardUsed.triple = true; pkgLeft+=3; log("ğŸ”º ä¸‰è¿ +3åŒ…");
        removeIndices(t); loop=true; continue;
      }
      const p = findPairs();
      if(p.length && !rewardUsed.pair){
        rewardUsed.pair = true; pkgLeft+=1; log("ğŸ¤ å¯¹ç¢° +1åŒ…");
        removeIndices(p); loop=true; continue;
      }
      if(new Set(board.filter(v=>v)).size===9 && !rewardUsed.fullhouse){
        rewardUsed.fullhouse = true; pkgLeft+=5; log("ğŸ§¿ å…¨å®¶ç¦ +5åŒ…");
        loop=true; continue;
      }
    }
  }

  // è¾…åŠ©
  function canTrigger(type){
    if(type==="triple"){
      const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8]];
      for(const l of lines){
        const vals=l.map(i=>board[i]).filter(v=>v);
        if(vals.length===2 && vals[0]===vals[1]) return vals[0];
      }
    }
    if(type==="pair"){
      const cnt={};
      board.forEach(v=>v&&(cnt[v]=(cnt[v]||0)+1));
      for(const c in cnt) if(cnt[c]===1) return c;
    }
    return null;
  }
  function canFullhouse(){
    return new Set(board.filter(v=>v)).size===8;
  }
  function pickMissingForFullhouse(){
    const used=new Set(board.filter(v=>v));
    for(const c of COLORS) if(!used.has(c)) return c;
    return COLORS[0];
  }
  function pickSafeColor(){
    for(const c of COLORS){
      if(c!==wishColor && !canTrigger("triple") && !canTrigger("pair")){
        return c;
      }
    }
    return COLORS[0];
  }

  function drawCell(i,c,anim=false){
    const d=$("gameArea").children[i];
    if(c===null){
      d.textContent=""; d.style.background="#add8e6"; d.style.color="#000"; d.classList.remove("show");
    } else {
      d.textContent=c; d.style.background=COLOR_HEX[c]; 
      d.style.color=BRIGHT.has(c)?"#000":"#fff";
      if(anim) setTimeout(()=>d.classList.add("show"),20);
      else d.classList.add("show");
    }
  }
  function removeIndices(arr){ arr.forEach(i=>{ board[i]=null; drawCell(i,null); }); }
  function removeAll(){ board=Array(9).fill(null); removeIndices([...Array(9).keys()]); }

  function findTriples(){
    const res=[], lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8]];
    for(const l of lines){
      const [a,b,c]=l;
      if(board[a]&&board[a]===board[b]&&board[b]===board[c]){
        res.push(a,b,c);
      }
    }
    return [...new Set(res)];
  }
  function findPairs(){
    const cnt={}, out=[];
    board.forEach((v,i)=>v&&(cnt[v]=(cnt[v]||[]).concat(i)));
    Object.values(cnt).forEach(a=>{ if(a.length===2) out.push(...a); });
    return out;
  }

  // æ‰‹åŠ¨æ¸…å°
  $("manualClearBtn").onclick = ()=>{
    if(pkgLeft===0 && opensDone===0) return;
    removeAll(); log("ğŸ§¹ æ‰‹åŠ¨æ¸…å°");
    
    $("pkgLeft").textContent = pkgLeft;
  };
</script>
</body>
</html>