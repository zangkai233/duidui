<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å‘åœˆå¯¹å¯¹ç¢°Â·æ–°ç‰ˆ</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* â€”â€” æ ·å¼ä¸å‰ä¸€ç‰ˆåŸºæœ¬ç›¸åŒï¼Œç•¥å»æ³¨é‡Š â€”â€” */
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f0f2f5;margin:0}
.container{max-width:960px;margin:auto;padding:20px}
.view{display:none}
.auth-container{max-width:420px;margin:80px auto;background:#fff;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.auth-container h2{text-align:center;margin-bottom:20px}
.auth-container input,.auth-container button{width:100%;padding:10px;margin:8px 0;box-sizing:border-box}
.auth-container a{color:#1677ff;cursor:pointer}
.topbar{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px 20px;box-shadow:0 2px 4px rgba(0,0,0,.08);position:relative}
#accountPanel{position:absolute;top:52px;right:20px;width:260px;background:#fff;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);overflow:hidden;height:0;transition:.3s;padding:0}
#accountPanel.open{height:220px;padding:12px}
.main{display:flex;margin-top:20px}
.sidebar{width:260px;background:#fff;padding:20px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.sidebar input,.sidebar button,.sidebar select{width:100%;padding:8px;margin:8px 0;box-sizing:border-box}
.content{flex:1;padding:0 24px}
#gameArea{display:grid;grid-template-columns:repeat(3,80px);grid-gap:12px;margin-top:20px;min-height:264px}
.cell{width:80px;height:80px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:bold;font-size:14px;color:#fff;opacity:0;transform:scale(.3);transition:.3s}
.cell.show{opacity:1;transform:scale(1)}
#scoreBoard{margin-top:12px;font-size:16px}
#logArea{height:160px;background:#fff;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-top:20px;padding:10px;overflow:auto;font-size:13px;line-height:1.45}
</style>
</head>
<body>
<div class="container">

  <!-- ç™»å½• -->
  <div id="loginView" class="view auth-container">
    <h2>ç™»å½•</h2>
    <input id="loginPhone" placeholder="æ‰‹æœºå· / admin">
    <input id="loginPass" type="password" placeholder="å¯†ç ">
    <button id="loginBtn">ç™»å½•</button>
    <p>æ²¡æœ‰è´¦å·ï¼Ÿ<a id="toRegister">æ³¨å†Œ</a></p>
  </div>

  <!-- æ³¨å†Œ -->
  <div id="registerView" class="view auth-container">
    <h2>æ³¨å†Œ</h2>
    <input id="regPhone" placeholder="æ‰‹æœºå·">
    <input id="regPass" type="password" placeholder="å¯†ç (â‰¥6ä½)">
    <button id="registerBtn">æ³¨å†Œ</button>
    <p>å·²æœ‰è´¦å·ï¼Ÿ<a id="toLogin">ç™»å½•</a></p>
  </div>

  <!-- æ¸¸æˆç•Œé¢ -->
  <div id="gameView" class="view">
    <div class="topbar">
      <div>å‘åœˆå¯¹å¯¹ç¢°</div>
      <div id="accountToggle" style="cursor:pointer">æˆ‘çš„è´¦æˆ·</div>
      <div id="accountPanel">
        <div>æ‰‹æœºå·: <span id="accountPhone"></span></div>
        <div>ä½™é¢:  <span id="accountBalance"></span> å…ƒ</div>
        <div>ç¤¼åŒ…:  <span id="accountBags"></span> åŒ…</div>
        <div>æ€»ç§¯åˆ†: <span id="accountTotal"></span></div>
        <div>ç§¯åˆ†å…‘æ¢: <input id="redeemPoints" type="number" min="1" placeholder="è¦å…‘æ¢çš„ç§¯åˆ†" style="width:60px;"> <button id="redeemBtn" style="padding:2px 6px;">å…‘æ¢</button></div>
        <button id="logoutBtn">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <div class="main">
      <!-- ä¾§è¾¹æ  -->
      <div class="sidebar">
        <h3>å……å€¼</h3><input id="rechargeAmount" type="number" min="1" placeholder="å……å€¼é‡‘é¢"><button id="rechargeBtn">æäº¤å……å€¼</button><p id="rechargeStatus" style="color:#f60"></p><button id="refreshBalance">åˆ·æ–°èµ„äº§</button>
        <hr>
        <h3>è´­ä¹°ç¤¼åŒ…</h3>
        <select id="packPrice">
          <option value="29.9">Â¥29.9 â†’ 2åŒ…</option>
          <option value="49.9">Â¥49.9 â†’ 3åŒ…</option>
          <option value="79.9">Â¥79.9 â†’ 5åŒ…</option>
          <option value="169.9">Â¥169.9 â†’ 10åŒ…</option>
          <option value="299.9">Â¥299.9 â†’ 20åŒ…</option>
        </select>
        <button id="buyPackBtn">è´­ä¹°ç¤¼åŒ…</button>
        <hr>
        <h3>æœ¬å±€å¼€åŒ…æ•°</h3>
        <select id="openCount">
          <option value="2">2 åŒ…</option>
          <option value="3">3 åŒ…</option>
          <option value="5">5 åŒ…</option>
          <option value="10">10 åŒ…</option>
          <option value="20">20 åŒ…</option>
        </select>
        <hr>
        <h3>è®¸æ„¿è‰²</h3>
        <select id="wishColorSelect"></select>
      </div>

      <!-- ä¸»å†…å®¹ -->
      <div class="content">
        <button id="startGameBtn">å¼€å§‹æ¸¸æˆ</button>
        <button id="manualClearBtn">æ‰‹åŠ¨æ¸…å°</button>
        <div id="gameArea"></div>
        <div id="scoreBoard">å‰©ä½™åŒ…æ•°: <span id="pkgLeft">0</span> | å¾—åˆ†: <span id="score">0</span></div>
        <div id="logArea"></div>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†å‘˜ -->
  <div id="adminView" class="view">
    <div class="topbar">
      <div>ç®¡ç†å‘˜å®¡æ ¸</div>
      <button id="logoutAdmin">é€€å‡ºç™»å½•</button>
    </div>
    <div class="content">
      <h3>å¾…å®¡è®¢å•</h3>
      <ul id="orderList"></ul>
    </div>
  </div>
</div>

<script>
/* ---------------- é…ç½®ä¸å¸¸é‡ ---------------- */
const apiBase="https://api.duidui.uk";
const COLORS=["çº¢","æ©™","é»„","ç»¿","è“","ç´«","ç²‰","é»‘","ç™½","ç°"];
const COLOR_HEX={çº¢:"#ff4d4f",æ©™:"#ffa940",é»„:"#ffec3d",ç»¿:"#73d13d",è“:"#40a9ff",ç´«:"#9254de",ç²‰:"#ff85c0",é»‘:"#595959",ç™½:"#ffffff",ç°:"#8c8c8c"};
const BRIGHT=new Set(["é»„","ç™½"]);
/* ---------------- å·¥å…· ---------------- */
const $=id=>document.getElementById(id);
function show(id){["loginView","registerView","gameView","adminView"].forEach(v=>$(v).style.display=v===id?"block":"none");}
function setUser(u){sessionStorage.setItem("u",JSON.stringify(u));}
function getUser(){return JSON.parse(sessionStorage.getItem("u")||"null");}
function clearUser(){sessionStorage.removeItem("u");}
function log(msg){const d=document.createElement("div");d.textContent=msg;$("logArea").appendChild(d);$("logArea").scrollTop=$("logArea").scrollHeight;}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
/* ---------------- åˆå§‹åŒ– ---------------- */
window.onload=()=>{COLORS.forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;$("wishColorSelect").appendChild(o);});const u=getUser();u?afterLogin(u.role,u.phone,u.extra):show("loginView");};
/* ---------------- ç™»å½•/æ³¨å†Œ ---------------- */
$("toRegister").onclick=()=>show("registerView");
$("toLogin").onclick   =()=>show("loginView");
$("registerBtn").onclick=async()=>{const p=$("regPhone").value.trim(),pwd=$("regPass").value;if(!p||!pwd)return alert("å¡«å®Œæ•´");const r=await fetch(apiBase+"/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:p,password:pwd})});const d=await r.json();d.status==="success"?(alert("æ³¨å†ŒæˆåŠŸ"),show("loginView")):alert(d.message);};
$("loginBtn").onclick=async()=>{const p=$("loginPhone").value.trim(),pwd=$("loginPass").value;if(!p||!pwd)return alert("å¡«å®Œæ•´");const r=await fetch(apiBase+"/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:p,password:pwd})});const d=await r.json();if(d.status!="success")return alert(d.message);afterLogin(d.role||"user",p,d);};
/* ---------------- ç™»å½•æˆåŠŸå¤„ç† ---------------- */
function afterLogin(role,phone,extra={}){setUser({role,phone});if(role==="admin"){loadOrders();show("adminView");}else{$("accountPhone").textContent=phone;$("accountBalance").textContent=(extra.balance||0).toFixed(2);$("accountBags").textContent=extra.bags||0;$("accountTotal").textContent=extra.total_score||0;show("gameView");}}
$("logoutBtn").onclick=$("logoutAdmin").onclick=()=>{clearUser();show("loginView");};
$("accountToggle").onclick=()=>$('accountPanel').classList.toggle('open');
/* ---------------- èµ„äº§åˆ·æ–° ---------------- */
$("refreshBalance").onclick=fetchProfile;
async function fetchProfile(){const u=getUser();if(!u)return;const r=await fetch(`${apiBase}/profile?phone=${u.phone}`);const d=await r.json();if(d.status==="success"){ $("accountBalance").textContent=d.balance.toFixed(2);$("accountBags").textContent=d.bags;$("accountTotal").textContent=d.total_score;}}

/* ---------------- å……å€¼/è´­ä¹°ç¤¼åŒ… ---------------- */
$("rechargeBtn").onclick=async()=>{const a=parseFloat($("rechargeAmount").value);if(isNaN(a)||a<=0)return alert("é‡‘é¢æ— æ•ˆ");$("rechargeStatus").textContent="å®¢æœå®¡æ ¸ä¸­";const u=getUser();await fetch(apiBase+"/order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:u.phone,amount:a})});};
$("buyPackBtn").onclick=async()=>{const price=parseFloat($("packPrice").value),u=getUser();const r=await fetch(apiBase+"/buy_pack",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:u.phone,price})});const d=await r.json();if(d.status!="success")return alert(d.message);$("accountBalance").textContent=d.balance.toFixed(2);$("accountBags").textContent=d.bags;alert("è´­ä¹°æˆåŠŸ");};

/* ---------------- ç§¯åˆ†å…‘æ¢åŠŸèƒ½ ---------------- */
$("redeemBtn").onclick=async()=>{
  const pts = parseInt($("redeemPoints").value,10);
  if(isNaN(pts)||pts<=0) return alert("è¯·è¾“å…¥æœ‰æ•ˆç§¯åˆ†");
  const u=getUser();
  // è°ƒç”¨åç«¯å…‘æ¢æ¥å£
  const res=await fetch(apiBase+"/redeem_points",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({phone:u.phone,points:pts})
  });
  const d=await res.json();
  if(d.status!="success") return alert(d.message);
  // æ›´æ–°é¢æ¿
  $("accountTotal").textContent=d.total_score;
  $("accountBags").textContent=d.bags;
  alert(`å…‘æ¢æˆåŠŸï¼šæ¶ˆè€— ${pts} ç§¯åˆ†ï¼Œè·å¾— ${pts*8} åŒ…`);
};

/* ---------------- ç®¡ç†å‘˜å®¡æ ¸ ---------------- */
async function loadOrders(){const r=await fetch(apiBase+"/orders");const d=await r.json();if(d.status!="success")return;$("orderList").innerHTML="";d.orders.forEach(o=>{const li=document.createElement("li");li.innerHTML=`æ‰‹æœºå·:${o.phone} é‡‘é¢:${o.amount}`;const b=document.createElement("button");b.textContent="æ‰¹å‡†";b.onclick=()=>approve(o.id);li.appendChild(b);$("orderList").appendChild(li);});}
async function approve(id){const r=await fetch(apiBase+"/order/approve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:id})});const d=await r.json();d.status==="success"?loadOrders():alert(d.message);}

/* =====================================================================
                             æ¸¸æˆé€»è¾‘
   =====================================================================*/
let board=[],pkgLeft=0,score=0,wishColor="",busy=false,gameEnded=false;
let rewardUsed={wish:false,triple:false,pair:false,clear:false,family:false};
let opensDone=0,desiredCount=0;

// å¼€å±€
$("startGameBtn").onclick=async()=>{if(busy)return;busy=true;const want=parseInt($("openCount").value,10);desiredCount=want;opensDone=0;const u=getUser();const r=await fetch(apiBase+"/start_game",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:u.phone,count:want})});const d=await r.json();if(d.status!="success"){busy=false;return alert(d.message);}pkgLeft=d.initial;score=0;board=Array(9).fill(null);wishColor=$("wishColorSelect").value;rewardUsed={wish:false,triple:false,pair:false,clear:false,family:false};gameEnded=false;$("accountBags").textContent=d.bags_left;$("pkgLeft").textContent=pkgLeft;$("score").textContent=score;$("gameArea").innerHTML="";for(let i=0;i<9;i++){const div=document.createElement("div");div.className="cell";$("gameArea").appendChild(div);}$("logArea").innerHTML="";log(`ğŸ® å¼€å§‹ï¼ç›®æ ‡å¼€åŒ…æ•°ï¼š${desiredCount} åŒ…ï¼Œè®¸æ„¿è‰²ï¼š${wishColor}`);await gameLoop();await endGame();};

// æ‰‹åŠ¨æ¸…å°
$("manualClearBtn").onclick=()=>{if(busy&&!gameEnded)manualClear();};

// è‡ªåŠ¨å¼€åŒ…å¾ªç¯
async function gameLoop(){while(opensDone<desiredCount&&pkgLeft>0&&!gameEnded){await openOnePackage();await sleep(700);}}

// ç»“æŸæµç¨‹ï¼šæäº¤ç§¯åˆ†å¹¶åˆ·æ–°èµ„äº§
async function endGame(){if(score>0){const u=getUser();await fetch(apiBase+"/submit_score",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({phone:u.phone,score})});}fetchProfile();busy=false;log("ğŸ‰ æœ¬å±€ç»“æŸ");}

// å¼€ä¸€åŒ…
async function openOnePackage(){if(gameEnded||opensDone>=desiredCount||pkgLeft<=0) return;const idx=board.indexOf(null);if(idx===-1){removeIndices([...Array(9).keys()]);board=Array(9).fill(null);log("âš ï¸ å°é¢æ»¡ï¼Œè‡ªåŠ¨æ¸…å°");return;}opensDone++;pkgLeft--;$("pkgLeft").textContent=pkgLeft;const color=COLORS[Math.random()*COLORS.length|0];board[idx]=color;drawCell(idx,color,true);log(`ğŸ“¦ å¼€åŒ…${opensDone}/${desiredCount}ï¼šæŠ½åˆ°ã€Œ${color}ã€`);if(color===wishColor&&!rewardUsed.wish){rewardUsed.wish=true;pkgLeft++;score++;log("ğŸ¯ è®¸æ„¿è‰² +1 åŒ…");}await checkRewardsLoop();$("pkgLeft").textContent=pkgLeft;$("score").textContent=score;}

// å¾ªç¯æ£€æŸ¥å¥–åŠ±
async function checkRewardsLoop(){let trig=true;while(trig&&!gameEnded){trig=false;const triples=findTriples();if(triples.length&&!rewardUsed.triple){rewardUsed.triple=true;pkgLeft+=3;score+=3;log("ğŸ”º ä¸‰è¿ +3 åŒ…");removeIndices(triples);await sleep(400);trig=true;continue;}const pairs=findPairs();if(pairs.length&&!rewardUsed.pair){rewardUsed.pair=true;pkgLeft+=1;score+=1;log("ğŸ¤ å¯¹ç¢° +1 åŒ…");removeIndices(pairs);await sleep(400);trig=true;continue;}if(new Set(board.filter(v=>v)).size===9&&!rewardUsed.family){rewardUsed.family=true;pkgLeft+=5;score+=5;log("ğŸ§¿ å…¨å®¶ç¦ +5 åŒ…");await sleep(200);trig=true;}}}

// æ‰‹åŠ¨æ¸…å°
function manualClear(){removeIndices([...Array(9).keys()]);board=Array(9).fill(null);log("ğŸ§¹ æ‰‹åŠ¨æ¸…å°");if(!rewardUsed.clear){rewardUsed.clear=true;pkgLeft+=3;score+=3;log("ğŸ’¥ æ¸…å° +3 åŒ…");}gameEnded=true;}

/* è¾…åŠ©å‡½æ•° */
function drawCell(i,color,newAdd=false){const d=$("gameArea").children[i];if(color===null){d.textContent="";d.style.background="#e8e8e8";d.style.color="#000";d.classList.remove("show");}else{d.textContent=color;d.style.background=COLOR_HEX[color];d.style.color=BRIGHT.has(color)?"#000":"#fff";if(newAdd)setTimeout(()=>d.classList.add("show"),20);else d.classList.add("show");}}
function removeIndices(arr){arr.forEach(i=>{board[i]=null;drawCell(i,null);});}
function findTriples(){const res=[];const idx=(r,c)=>r*3+c;for(let r=0;r<3;r++)if(board[idx(r,0)]&&board[idx(r,0)]===board[idx(r,1)]&&board[idx(r,1)]===board[idx(r,2)])res.push(idx(r,0),idx(r,1),idx(r,2));for(let c=0;c<3;c++)if(board[idx(0,c)]&&board[idx(0,c)]===board[idx(1,c)]&&board[idx(1,c)]===board[idx(2,c)])res.push(idx(0,c),idx(1,c),idx(2,c));return[...new Set(res)];}
function findPairs(){const cnt={},p=[];board.forEach((v,i)=>{if(v)cnt[v]=(cnt[v]||[]).concat(i);} );Object.values(cnt).forEach(a=>{if(a.length===2)p.push(...a);} );return p;}
</script>
</body>
</html>
